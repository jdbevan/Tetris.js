(function(k,j){var l=function(){var b={bgColor:"#EEEEEE",score:0,isColorEqual:function(b,e){if(null!==b.match(/^#/)){if(null!==e.match(/^#/))return b==e;var c=b.substr(1),c=[parseInt(c.substr(0,2),16),parseInt(c.substr(2,2),16),parseInt(c.substr(4,2),16)];return e=="rgb("+c[0]+", "+c[1]+", "+c[2]+")"}return null!==e.match(/^#/)?(c=e.substr(1),c=[parseInt(c.substr(0,2),16),parseInt(c.substr(2,2),16),parseInt(c.substr(4,2),16)],b=="rgb("+c[0]+", "+c[1]+", "+c[2]+")"):b==e},makeGrid:function(a,e){if(4>
a)return!1;if(8>e)return!1;$("head").append("<style>#tetrisgame { font-family: arial; }\n#tetrisgrid .row { height: 22px; float: left; clear:both; }\n#tetrisgrid .col { float: left; margin-right: 2px; width: 20px; height: 20px; }</style>");$("body").append("<div id='tetrisgame'><div>Arrow keys move and rotate.<br>\nZ drops current piece, R resets game.</div>\n<div id='tetrisinfo'></div>\n<div id='tetrisgrid'></div></div>");this.pieces.addPiece("block",[[1,1],[1,1]],"red");this.pieces.addPiece("tower",
[[1],[1],[1],[1]],"yellow");this.pieces.addPiece("step",[[0,1],[1,1]],"green");this.pieces.addPiece("L1",[[0,0,1],[1,1,1]],"blue");this.pieces.addPiece("L2",[[1,0,0],[1,1,1]],"purple");this.pieces.addPiece("diagonal",[[1,0],[0,1]],"black");this.pieces.addPiece("T",[[0,1,0],[1,1,1]],"orange");$(document).keydown(function(c){if(82==c.keyCode){if(null!==b.activeShape)clearInterval(b.activeShape.i),b.activeShape=null;b.grid.reset();b.speed=1500;b.score=0}var a={width:b.activeShape.width,height:b.activeShape.height,
loc:{x:b.activeShape.loc.x,y:b.activeShape.loc.y},blocks:b.activeShape.blocks,rotate:b.activeShape.rotate};if(37==c.keyCode)0<a.loc.x&&a.loc.x--,b.moveShapeIfNoCollision(a);else if(39==c.keyCode)a.loc.x+a.width<b.grid.width&&a.loc.x++,b.moveShapeIfNoCollision(a);else if(38==c.keyCode)a.rotate(-1),b.moveShapeIfNoCollision(a);else if(40==c.keyCode)a.rotate(1),b.moveShapeIfNoCollision(a);else if(90==c.keyCode){c=a.loc.y;for(a.loc.y=b.grid.height-a.height;a.loc.y>c&&b.grid.collisionCheck(a);a.loc.y--);
b.moveShapeIfNoCollision(a)}});this.grid={width:a,height:e,state:[],selector:"#tetrisgame #tetrisgrid",reset:function(){$(this.selector).empty();this.state=this.drawGrid(this.height,this.width);this.start()},drawGrid:function(a,g){for(var e=[],d=0;d<a;d++){$(this.selector).append("<div class='row'></div>");e[d]=[];for(var f=0;f<g;f++)$(this.selector+" .row").eq(d).append("<div class='col' style='background-color: "+b.bgColor+"'></div>"),e[d][f]=0}return e},start:function(){b.makeShape().startFall();
500<b.speed&&(b.speed-=10)},newShape:function(){this.start()},collisionCheck:function(a){if(0>a.loc.x||a.width+a.loc.x>this.width||a.height+a.loc.y>this.height)return!0;for(var b=0,e=a.width;b<e;b++)for(var d=0,f=a.height;d<f;d++)if(0<=d+a.loc.y&&1===a.blocks[d][b]&&1===this.state[d+a.loc.y][b+a.loc.x])return!0;return!1},storeShape:function(a){for(var b=0,e=a.width;b<e;b++)for(var d=0,f=a.height;d<f;d++)1===a.blocks[d][b]&&0<=a.loc.y&&(this.state[d+a.loc.y][b+a.loc.x]=1)},clearFullRows:function(a){if(0>
a||a>this.height)return!1;for(;a<this.height;a++){for(var e=!0,h=0;h<this.width;h++)if(0===this.state[a][h]){e=!1;break}e&&$(this.selector+" .row").eq(a).fadeOut("slow",function(){var a=[],c=$(this).prevAll().length;$(this).remove();b.score+=10;$(b.grid.selector).prepend("<div class='row'></div>");for(var e=0;e<b.grid.width;e++)$(b.grid.selector+" .row").eq(0).append("<div class='col' style='background-color: "+b.bgColor+"'></div>"),a[e]=0;b.grid.state.splice(c,1);b.grid.state.unshift(a);b.output("Score: "+
b.score)})}}};this.grid.state=this.grid.drawGrid(e,a);return this.grid},isPieceAt:function(a){return 0<=a.x&&a.x<this.grid.width&&0<=a.y&&a.y<this.grid.height?1==this.grid.state[a.y][a.x]:!1},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},pieces:{addPiece:function(a,b,c){this.names[a]=this.pieces.length;this.pieces[this.pieces.length]={color:c,structure:b,dimensions:{width:b[0].length,height:b.length}};this.total++},getPiece:function(a){return b.isNumber(a)&&0<=a&&a<this.total?this.pieces[a]:
b.isNumber(a)?!1:this.pieces[this.names[a]]},pieces:[],names:{},total:0},makeShape:function(){var a=Math.floor(Math.random()*b.pieces.total),a=b.pieces.getPiece(a);return{width:a.dimensions.width,height:a.dimensions.height,blocks:a.structure,color:a.color,loc:{x:Math.floor(b.grid.width/2-1),y:-a.dimensions.height},fall:function(){if(null===b.activeShape)b.activeShape=this,b.displayShape(this);else if(this.loc.y<b.grid.height-this.height){if(b.grid.collisionCheck({width:this.width,height:this.height,
loc:{x:this.loc.x,y:this.loc.y+1},blocks:this.blocks}))return this.stopFalling();b.removeShape(this);this.loc.y++;b.displayShape(this);if(b.grid.collisionCheck({width:this.width,height:this.height,loc:{x:this.loc.x,y:this.loc.y+1},blocks:this.blocks}))return this.stopFalling()}else this.stopFalling();b.output("Score: "+b.score)},startFall:function(){var a=this;a.fall();this.i=setInterval(function(){a.fall()},b.speed)},stopFalling:function(){clearInterval(this.i);b.activeShape=null;b.grid.storeShape(this);
console.log("Stopped");0<this.loc.y?(b.grid.clearFullRows(this.loc.y),b.grid.newShape()):(console.log("Game Over"),b.output("Score: "+b.score+" - Game Over!"),$(b.grid.selector+" .row").each(function(){$(this).find(".col").delay(250).fadeTo("slow",0.5)}));return!0},rotate:function(a){var c=this.width,g=this.height,h=this.blocks,d={x:this.loc.x,y:this.loc.y};if(0<a)this.blocks=b.rotateClock(this.blocks);else if(0>a)this.blocks=b.rotateAnticlock(this.blocks);this.height=this.blocks.length;this.width=
this.blocks[0].length;this.height>g?this.loc.y-=this.height-g:this.height<g&&(this.loc.y+=g-this.height);if(b.grid.collisionCheck(this))this.blocks=h,this.loc=d,this.height=g,this.width=c}}},displayShape:function(a){for(var e=a.loc,c=0;c<a.height;c++)for(var g=0;g<a.width;g++)if(1==a.blocks[c][g]){var h=e.y+c,d=e.x+g;0<=d&&d<b.grid.width&&0<=h&&h<b.grid.height&&$(b.grid.selector+" .row").eq(h).find(".col").eq(d).css("background-color",a.color)}},rotateClock:function(a){console.log("Rotate clockwise");
return this.rotateArray(a,1)},rotateAnticlock:function(a){console.log("Rotate anticlockwise");return this.rotateArray(a,-1)},rotateArray:function(a,b){for(var c=[],g=a.length,h=a[0].length,d=0;d<g;d++)for(var f=0;f<h;f++){var i=a[d][f];0>b?(c[h-1-f]===j&&(c[h-1-f]=[]),c[h-1-f][d]=i):0<b?(c[f]===j&&(c[f]=[]),c[f][g-1-d]=i):c[d][f]=i}return c},removeShape:function(a){this.displayShape(jQuery.extend(!0,{},a,{color:b.bgColor}))},moveShapeIfNoCollision:function(a){if(this.grid.collisionCheck(a))return!1;
this.removeShape(this.activeShape);this.activeShape.width=a.width;this.activeShape.height=a.height;this.activeShape.blocks=a.blocks;this.activeShape.loc=a.loc;this.displayShape(this.activeShape);return!0},output:function(a){$("#tetrisgame #tetrisinfo").html(a)},activeShape:null,speed:1500};return b}();k.tetris=l})(window);
