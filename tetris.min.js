(function(k,j){var l=function(){var b={bgColor:"#EEEEEE",score:0,scoreUnit:10,isColorEqual:function(a,b){if(null!==a.match(/^#/)){if(null!==b.match(/^#/))return a==b;var d=a.substr(1),d=[parseInt(d.substr(0,2),16),parseInt(d.substr(2,2),16),parseInt(d.substr(4,2),16)];return b=="rgb("+d[0]+", "+d[1]+", "+d[2]+")"}return null!==b.match(/^#/)?(d=b.substr(1),d=[parseInt(d.substr(0,2),16),parseInt(d.substr(2,2),16),parseInt(d.substr(4,2),16)],a=="rgb("+d[0]+", "+d[1]+", "+d[2]+")"):a==b},makeGrid:function(a,
f){if(4>a||8>f)return!1;$("head").append("<style>#tetrisgame { font-family: arial; }\n#tetrisgrid .row { height: 22px; float: left; clear:both; }\n#tetrisgrid .col { float: left; margin-right: 2px; width: 20px; height: 20px; }</style>");$("body").append("<div id='tetrisgame'><div>Arrow keys move and rotate.<br>\nZ drops current piece, R resets game.</div>\n<div id='tetrisinfo'></div>\n<div id='tetrisgrid'></div></div>");this.pieces.addPieceWithProbability("square",[[1,1],[1,1]],"red",0.2);this.pieces.addPieceWithProbability("tower",
[[1],[1],[1],[1]],"yellow",0.15);this.pieces.addPieceWithProbability("step",[[0,1],[1,1]],"green",0.1);this.pieces.addPieceWithProbability("L1",[[0,0,1],[1,1,1]],"blue",0.3);this.pieces.addPieceWithProbability("L2",[[1,0,0],[1,1,1]],"purple",0.3);this.pieces.addPieceWithProbability("diagonal",[[1,0],[0,1]],"black",0.1);this.pieces.addPieceWithProbability("T",[[0,1,0],[1,1,1]],"orange",0.2);$(document).keydown(function(a){82==a.keyCode&&(null!==b.activeShape&&(clearInterval(b.activeShape.i),b.activeShape=
null),b.grid.reset(),b.speed=1500,b.score=0);var c={width:b.activeShape.width,height:b.activeShape.height,loc:{x:b.activeShape.loc.x,y:b.activeShape.loc.y},blocks:b.activeShape.blocks,rotate:b.activeShape.rotate};if(37==a.keyCode)0<c.loc.x&&c.loc.x--,b.moveShapeIfNoCollision(c);else if(39==a.keyCode)c.loc.x+c.width<b.grid.width&&c.loc.x++,b.moveShapeIfNoCollision(c);else if(38==a.keyCode)c.rotate(-1),b.moveShapeIfNoCollision(c);else if(40==a.keyCode)c.rotate(1),b.moveShapeIfNoCollision(c);else if(90==
a.keyCode){a=c.loc.y;for(c.loc.y=b.grid.height-c.height;c.loc.y>a&&b.grid.collisionCheck(c);c.loc.y--);b.moveShapeIfNoCollision(c)}});this.grid={width:a,height:f,state:[],selector:"#tetrisgame #tetrisgrid",reset:function(){$(this.selector).empty();this.state=this.drawGrid(this.height,this.width);this.start()},drawGrid:function(a,c){for(var f=[],e=0;e<a;e++){$(this.selector).append("<div class='row'></div>");f[e]=[];for(var g=0;g<c;g++)$(this.selector+" .row").eq(e).append("<div class='col' style='background-color: "+
b.bgColor+"'></div>"),f[e][g]=0}return f},start:function(){b.makeShape().startFall();500<b.speed&&(b.speed-=10)},newShape:function(){this.start()},collisionCheck:function(a){if(0>a.loc.x||a.width+a.loc.x>this.width||a.height+a.loc.y>this.height)return!0;for(var b=0,f=a.width;b<f;b++)for(var e=0,g=a.height;e<g;e++)if(0<=e+a.loc.y&&1===a.blocks[e][b]&&1===this.state[e+a.loc.y][b+a.loc.x])return!0;return!1},storeShape:function(a){for(var b=0,f=a.width;b<f;b++)for(var e=0,g=a.height;e<g;e++)1===a.blocks[e][b]&&
0<=a.loc.y&&(this.state[e+a.loc.y][b+a.loc.x]=1)},clearFullRows:function(a){if(0>a||a>this.height)return!1;for(;a<this.height;a++){for(var c=!0,f=0;f<this.width;f++)if(0===this.state[a][f]){c=!1;break}c&&(c=Math.min(600,b.speed),$(this.selector+" .row").eq(a).fadeOut(c,function(){var a=[],c=$(this).prevAll().length;$(this).remove();b.score+=c<b.grid.height/4?2*b.scoreUnit:b.scoreUnit;$(b.grid.selector).prepend("<div class='row'></div>");for(var f=0;f<b.grid.width;f++)$(b.grid.selector+" .row").eq(0).append("<div class='col' style='background-color: "+
b.bgColor+"'></div>"),a[f]=0;b.grid.state.splice(c,1);b.grid.state.unshift(a);b.output("Score: "+b.score)}))}}};this.grid.state=this.grid.drawGrid(f,a);return this.grid},isPieceAt:function(a){return 0<=a.x&&a.x<this.grid.width&&0<=a.y&&a.y<this.grid.height?1==this.grid.state[a.y][a.x]:!1},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},pieces:{addPieceWithProbability:function(a,f,d,c){this.names[a]=this.pieces.length;if(!b.isNumber(c)||0>c||1<c)c=1;this.pieces[this.pieces.length]={color:d,
structure:f,dimensions:{width:f[0].length,height:f.length},origProb:c,prob:0,cumulativeProb:0};this.totalGivenProbability+=c;this.total++;this.calculateRelativeProbabilities()},calculateRelativeProbabilities:function(){if(0<this.totalGivenProbability)for(var a=0;a<this.pieces.length;a++)this.pieces[a].prob=1/this.totalGivenProbability*this.pieces[a].origProb,this.pieces[a].cumulativeProb=0<a?this.pieces[a].prob+this.pieces[a-1].cumulativeProb:this.pieces[a].prob},getPieceProbably:function(){var a=
Math.random();console.log(a);return this.binarySearch(this.pieces.length,0,a)},binarySearch:function(a,b,d){var c=b+Math.floor((a-b)/2);if(1==a-b)return this.pieces[a-1];if(d==this.pieces[c].cumulativeProb)return this.pieces[c];d<this.pieces[c].cumulativeProb?a=c:b=c;return this.binarySearch(a,b,d)},addPiece:function(a,b,d){this.addPieceWithProbability(a,b,d,1)},getPiece:function(a){return b.isNumber(a)&&0<=a&&a<this.total?this.pieces[a]:b.isNumber(a)?!1:this.pieces[this.names[a]]},pieces:[],names:{},
total:0,totalGivenProbability:0},makeShape:function(){var a=b.pieces.getPieceProbably();return{width:a.dimensions.width,height:a.dimensions.height,blocks:a.structure,color:a.color,loc:{x:Math.floor(b.grid.width/2-1),y:-a.dimensions.height},fall:function(){if(null===b.activeShape)b.activeShape=this,b.displayShape(this);else if(this.loc.y<b.grid.height-this.height){if(b.grid.collisionCheck({width:this.width,height:this.height,loc:{x:this.loc.x,y:this.loc.y+1},blocks:this.blocks}))return this.stopFalling();
b.removeShape(this);this.loc.y++;b.displayShape(this);if(b.grid.collisionCheck({width:this.width,height:this.height,loc:{x:this.loc.x,y:this.loc.y+1},blocks:this.blocks}))return this.stopFalling()}else this.stopFalling();b.output("Score: "+b.score)},startFall:function(){var a=this;a.fall();this.i=setInterval(function(){a.fall()},b.speed)},stopFalling:function(){clearInterval(this.i);b.activeShape=null;b.grid.storeShape(this);0<this.loc.y?(b.grid.clearFullRows(this.loc.y),b.grid.newShape()):(console.log("Game Over"),
b.output("Score: "+b.score+" - Game Over!"),$(b.grid.selector+" .row").each(function(){$(this).find(".col").delay(250).fadeTo("slow",0.5)}));return!0},rotate:function(a){var d=this.width,c=this.height,h=this.blocks,e={x:this.loc.x,y:this.loc.y};0<a?this.blocks=b.rotateClock(this.blocks):0>a&&(this.blocks=b.rotateAnticlock(this.blocks));this.height=this.blocks.length;this.width=this.blocks[0].length;this.height>c?this.loc.y-=this.height-c:this.height<c&&(this.loc.y+=c-this.height);b.grid.collisionCheck(this)&&
(this.blocks=h,this.loc=e,this.height=c,this.width=d)}}},displayShape:function(a){for(var f=a.loc,d=0;d<a.height;d++)for(var c=0;c<a.width;c++)if(1==a.blocks[d][c]){var h=f.y+d,e=f.x+c;0<=e&&e<b.grid.width&&0<=h&&h<b.grid.height&&$(b.grid.selector+" .row").eq(h).find(".col").eq(e).css("background-color",a.color)}},rotateClock:function(a){return this.rotateArray(a,1)},rotateAnticlock:function(a){return this.rotateArray(a,-1)},rotateArray:function(a,b){for(var d=[],c=a.length,h=a[0].length,e=0;e<c;e++)for(var g=
0;g<h;g++){var i=a[e][g];0>b?(d[h-1-g]===j&&(d[h-1-g]=[]),d[h-1-g][e]=i):0<b?(d[g]===j&&(d[g]=[]),d[g][c-1-e]=i):d[e][g]=i}return d},removeShape:function(a){this.displayShape(jQuery.extend(!0,{},a,{color:b.bgColor}))},moveShapeIfNoCollision:function(a){if(this.grid.collisionCheck(a))return!1;this.removeShape(this.activeShape);this.activeShape.width=a.width;this.activeShape.height=a.height;this.activeShape.blocks=a.blocks;this.activeShape.loc=a.loc;this.displayShape(this.activeShape);return!0},output:function(a){$("#tetrisgame #tetrisinfo").html(a)},
activeShape:null,speed:1E3};return b}();k.tetris=l})(window);
